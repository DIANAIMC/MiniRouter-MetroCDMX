%linea 1
estacion(observatorio,tacubaya,3).
estacion(tacubaya,juanacatlan,3).
estacion(juanacatlan,chapultepec,3).
estacion(chapultepec,sevilla,1).
estacion(sevilla,insurgentes,2).
estacion(insurgentes,cuahutemoc,3).
estacion(cuahutemoc,balderas,1).
estacion(balderas,salto_de_agua,1).
estacion(salto_de_agua,isabel_la_catolica,2).
estacion(isabel_la_catolica,pino_suarez,1).
estacion(pino_suarez,merced,2).
estacion(merced,candelaria,2).
estacion(candelaria,san_lazaro,3).
estacion(san_lazaro,moctezuma,1).
estacion(moctezuma,balbuena,2).
estacion(balbuena,blvd_puerto_aereo,2).
estacion(blvd_puerto_aereo,gomez_farias,2).
estacion(gomez_farias,zaragoza,2).
estacion(zaragoza,pantitlan,4).
estacion(pantitlan,zaragoza,4).
 
 
%linea 2
estacion(cuatro_caminos,panteones,4).
estacion(panteones,tacuba,4).
estacion(tacuba,cuitlahuac,2).
estacion(cuitlahuac,popotla,2).
estacion(popotla,colegio_militar,1).
estacion(colegio_militar,normal,2).
estacion(normal,san_cosme,1).
estacion(san_cosme,revolucion,2).
estacion(revolucion,hidalgo,2).
estacion(hidalgo,bellas_artes,1).
estacion(bellas_artes,allende,2).
estacion(allende,zocalo,1).
estacion(zocalo,pino_suarez,3).
estacion(pino_suarez,san_antonio_abad,2).
estacion(san_antonio_abad,chabacano,2).
estacion(chabacano,viaducto,2).
estacion(viaducto,xola,1).
estacion(xola,villa_de_cortes,3).
estacion(villa_de_cortes,metro_nativitas,2).
estacion(metro_nativitas,portales,2).
estacion(portales,ermita,2).
estacion(ermita,general_anaya,3).
estacion(general_anaya,tasquena,3).
 
%linea 3
estacion(universidad,copilco, 3).
estacion(copilco,miguel_angel, 4).
estacion(miguel_angel,viveros, 2).
estacion(viveros,coyoacan,3).
estacion(coyoacan,zapata,3).
estacion(zapata,division_del_norte,2).
estacion(division_del_norte,eugenia,2).
estacion(eugenia,etiopia,3).
estacion(etiopia,centro_medico,3).
estacion(centro_medico,hospital_general,2).
estacion(hospital_general,ninos_heroes,2).
estacion(ninos_heroes,balderas,1).
estacion(balderas,juarez,2).
estacion(juarez,hidalgo,1).
estacion(hidalgo,guerrero,2).
estacion(guerrero,tlatelolco,3).
estacion(tlatelolco,la_raza,4).
estacion(la_raza,potrero,3).
estacion(potrero,deportivo_18_de_marzo,3).
estacion(deportivo_18_de_marzo,indios_verdes,3).
 
%linea 4
estacion(bondojito,martin_carrera,3).
estacion(martin_carrera,bondojito,3).
estacion(bondojito,consulado,2).
estacion(consulado,canal_del_norte,2).
estacion(canal_del_norte,morelos,3).
estacion(morelos,candelaria,3).
estacion(candelaria,fray_servando,2).
estacion(fray_servando,jamaica,2).
estacion(jamaica,santa_anita,3).

%linea 5
estacion(politecnico,instituto_del_petroleo,3).
estacion(instituto_del_petroleo,autobuses_del_norte,3).
estacion(autobuses_del_norte,la_raza,3).
estacion(la_raza,misterios,2).
estacion(misterios,valle_gomez,3).
estacion(valle_gomez,consulado,2).
estacion(consulado,eduardo_molina,2).
estacion(eduardo_molina,aragon,2).
estacion(aragon,oceania,4).
estacion(oceania,terminal_aerea,4).
estacion(terminal_aerea,hangares,3).
estacion(hangares,pantitlan,4).
 
 
%linea 6
estacion(tezozomoc,el_rosario,3).
estacion(el_rosario,tezozomoc,3).
estacion(tezozomoc,azcapotzalco,3).
estacion(azcapotzalco,ferreria,3).
estacion(ferreria,norte_45,3).
estacion(norte_45,vallejo,3).
estacion(vallejo,instituto_del_petroleo,2).
estacion(instituto_del_petroleo,lindavista,3).
estacion(lindavista,deportivo_18_de_marzo,2).
estacion(deportivo_18_de_marzo,la_villa,2).
estacion(la_villa,martin_carrera,3).
 
 
%linea 7
estacion(mixcoac,barranca_del_muerto,4).
estacion(barranca_del_muerto,mixcoac,4).
estacion(mixcoac,san_antonio,2).
estacion(san_antonio,san_pedro_de_los_pinos,2).
estacion(san_pedro_de_los_pinos,tacubaya,3).
estacion(tacubaya,constituyentes,3).
estacion(constituyentes,auditorio,4).
estacion(auditorio,polanco,2).
estacion(polanco,san_joaquin,3).
estacion(san_joaquin,tacuba,5).
estacion(tacuba,refineria,3).
estacion(refineria,camarones,3).
estacion(camarones,aquiles_serdan,3).
estacion(aquiles_serdan,el_rosario,5).
 
 
%linea 8
estacion(garibaldi,bellas_artes,4).
estacion(bellas_artes,san_juan_de_letran,2).
estacion(san_juan_de_letran,salto_de_agua,1).
estacion(salto_de_agua,doctores,2).
estacion(doctores,obrera,2).
estacion(obrera,chabacano,3).
estacion(chabacano,la_viga,2).
estacion(la_viga,santa_anita,2).
estacion(santa_anita,coyuya,3).
estacion(coyuya,iztacalco,2).
estacion(iztacalco,apatlaco,3).
estacion(apatlaco,aculco,1).
estacion(aculco,escuadron_201,3).
estacion(escuadron_201,atlalilco,4).
estacion(atlalilco,iztapalapa,3).
estacion(iztapalapa,cerro_de_la_estrella,2).
estacion(cerro_de_la_estrella,uam,4).
estacion(uam,constitucion_de_1917,3).
 
 
%linea 9
estacion(pantitlan,puebla,4).
estacion(puebla,ciudad_deportiva,2).
estacion(ciudad_deportiva,velodromo,3).
estacion(velodromo,mixiuhca,2).
estacion(mixiuhca,jamaica,3).
estacion(jamaica,chabacano,3).
estacion(chabacano,lazaro_cardenas,2).
estacion(lazaro_cardenas,centro_medico,3).
estacion(centro_medico,chilpancingo,3).
estacion(chilpancingo,patriotismo ,3).
estacion(patriotismo,tacubaya,3).
 
%linea A
estacion(la_paz,los_reyes,5).
estacion(los_reyes,santa_maria,5).
estacion(santa_maria,acatitla,3).
estacion(acatitla,penon_viejo,3).
estacion(penon_viejo,guelatao,6).
estacion(guelatao,tepalcates,3).
estacion(tepalcates,canal_de_san_juan,4).
estacion(canal_de_san_juan,agricola_oriental,3).
estacion(agricola_oriental,pantitlan,3).
 
%linea B
estacion(ciudad_azteca,plaza_aragon,2).
estacion(plaza_aragon,olimpica,2).
estacion(olimpica,ecatepec,1).
estacion(ecatepec,muzquiz,4).
estacion(muzquiz,rio_de_los_remedios,3).
estacion(rio_de_los_remedios,impulsora,2).
estacion(impulsora,nezahualcoyotl,4).
estacion(nezahualcoyotl,villa_de_aragon,3).
estacion(villa_de_aragon,bosque_de_aragon,2).
estacion(bosque_de_aragon,deportivo_oceania,4).
estacion(deportivo_oceania,oceania,2).
estacion(oceania,romero_rubio,2).
estacion(romero_rubio,ricardo_flores_magon,3).
estacion(ricardo_flores_magon,san_lazaro,2).
estacion(san_lazaro,morelos,4).
estacion(morelos,tepito,1).
estacion(tepito,lagunilla,2).
estacion(lagunilla,garibaldi,2).
estacion(garibaldi,guerrero,2).
estacion(guerrero,buenavista,1).

:-dynamic caso/8.
:-dynamic id_contador/1.
%Caso(Id,Inicio, Fin, Tiempo, lista con la ruta, num estaciones, 
%lista con los transbordos, num transbordos).
caso(1,observatorio,zaragoza,40,[observatorio,tacubaya,juanacatlan,chapultepec,sevilla,insurgentes,cuahutemoc,balderas,salto_de_agua,isabel_la_catolica,pino_suarez,merced,
                                  candelaria,san_lazaro,moctezuma,balbuena,blvd_puerto_aereo,gomez_farias,zaragoza,pantitlan],20,[tacubaya,balderas,salto_de_agua,pino_suarez,
                                  candelaria,san_lazaro,pantitlan],7).
caso(2,cuatro_caminos,general_anaya,49,[cuatro_caminos,panteones,tacuba,cuitlahuac,colegio_militar,normal,san_cosme,revolucion,hidalgo,bellas_artes,allende,zocalo,pino_suarez,
                                  san_antonio_abad,chabacano,viaducto,xola,villa_de_cortes,metro_nativitas,portales,ermita,general_anaya,tasqueña],24,[tacuba,hidalgo,bellas_artes,
                                  pino_suarez,chabacano],5).
caso(3,univesidad,indios_verdes,51,[universidad,copilco,miguel_angel,viveros,coyoacan,zapata,division_del_norte,eugenia,etiopia,centro_medico,hospital_general,ninos_heroes,
                                  balderas,juarez,hidalgo,guerrero,tlatelolco,la_raza,potrero,deportivo_18_de_marzo,indios_verdes],21,[centro_medico,balderas,hidalgo,guerrero,
                                  la_raza,deportivo_18_de_marzo],6).
caso(4,martin_carrera,santa_anita,26,[martin_carrera,talisman,bondojito,consulado,canal_del_norte,morelos,candelaria,fray_servando,jamaica,santa_anita],11,[martin_carrera,consulado,
								  morelos,candelaria,jamaica,santa_anita],6).
caso(5,politecnico,pantitlan,35,[politecnico,instituto_del_petroleo,la_raza,misterios,valle_gomez,consulado,eduardo_molina,aragon,oceania,terminal_aerea,hangares,pantitlan],11,
     							  [instituto_del_petroleo,la_raza,consulado,oceania,pantitlan],5).
caso(6,el_rosario,martin_carrera,29,[el_rosario,tezozomoc,azcapotzalco,ferreria,norte_45,vallejo,instituto_del_petroleo,lindavista,deportivo_18_de_marzo,la_villa,martin_carrea],11,
     							  [instituto_del_petroleo,deportivo_18_de_marzo,martin_carrea],3).
caso(7,barranca_del_muerto,el_rosario,42,[barranca_del_muerto,mixcoac,san_antonio,san_pedro_de_los_pinos,tacubaya,constituyentes,auditorio,polanco,san_joaquin,tacuba,refineria,camarones,
                                  aquiles_serdan,el_rosario],14,[tacubaya,tacuba,el_rosario],3).
caso(8,garibaldi,constitucion_de_1917,46,[garibaldi,bellas_artes,san_juan_de_letran,salto_de_agua,doctores,obrera,chabacano,la_viga,santa_anita,coyuya,iztacalco,apatlaco,aculco,
                                  escuadron_201,atlalilco,iztapalapa,cerro_de_la_estrella,uam,constitucion_de_1917],18,[atlalilco,santa_anita,chabacano,salto_del_agua,bellas_artes,
                                  garibaldi],6).
caso(9,pantitlan,tacubaya,31,[pantitlan,puebla,ciudad_deportiva,velodromo,mixiuhca,jamaica,chabacano,lazaro_cardenas,centro_medico,chilpancingo,patriotismo,tacubaya],12,[tacubaya,
							      centro_medico,chabacano,jamaica,pantitlan],5).
caso(10,la_paz,pantitlan,35,[la_paz,los_reyes,santa_maria,acatitla,penon_viejo,guelatao,tepalcates,canal_de_san_juan,canal_de_san_juan,agricola_oriental,pantitlan],11,[pantitlan],1).
caso(11,ciudad_azteca,buenavista,48,[ciudad_azteca,plaza_aragon,olimpica,ecatepec,muzquiz,rio_de_los_remedios,impulsora,nezahualcoyotl,villa_de_aragon,bosque_de_aragon,deportivo_oceania,oceania,
                                  romero_rubio,ricardo_flores_magon,san_lazaro,morelos,tepito,lagunilla,garibaldi,guerrero,buenavista],21,[guerrero,garibaldi,morelos,san_lazaro,oceania],5).


id_contador(0). %para saber cuántos casos hay en total :) 

%la regla conectado se usa para no tener que declarar las rutas dos veces. 
%Si X esta conectado a Y, Y esta conectado a X, con el mismo numero de minutos.
conectado(X,Y,L) :-
	estacion(X,Y,L) ; estacion(Y,X,L).
%la regla es_transbordo permite saber si una estacion es transbordo.	
es_transbordo(X):-
	estacion(X, Y, _),
    estacion(X, Z, _),
	Z \== Y.

%Las reglas calcula_numero_de_transbordos indican cuantas estaciones de transbordos son recorridas.
calcula_numero_de_transbordos([], X):-
	print("SI LLEGUE"), nl,
	print(X).
calcula_numero_de_transbordos([Estacion|ListaEstaciones], NTransbordos) :-
	print(Estacion),
	(es_transbordo(Estacion) -> 	 
   	 N is NTransbordos+1,
    	calcula_numero_de_transbordos(ListaEstaciones,N);
   	 calcula_numero_de_transbordos(ListaEstaciones,NTransbordos)
	).
calcula_numero_de_transbordos(Lista):-
	calcula_numero_de_transbordos(Lista,0).
 
%camino es la regla que llama a viaje. Le ingresas inicio (A), destino (B), y obtienes la ruta (Camino) 
%y cuanto dura en minutos (Tiempo).
camino(A,B,Camino,Tiempo) :-
   	viaje(A,B,[A],Q,Tiempo),
   	reverse(Q,Camino).
 
%las reglas viajes obtienen una ruta entre el origen y destino. Esta ruta no es necesariamente la mas optima; 
%en realidad se obtiene conforme a como fueron declarados los hechos de las estaciones.
viaje(A,B,P,[B|P],L) :-
   	conectado(A,B,L).
viaje(A,B,Visitado,Camino,L) :-
   	conectado(A,C,D),      	 
   	C \== B,
   	\+member(C,Visitado),
   	viaje(C,B,[C|Visitado],Camino,L1),
   	L is D+L1.  

%min_ruta calcula todos las rutas posibles, y regresa el más corto.
min_ruta(A,B,Camino,Tiempo) :-
   setof([P,L],camino(A,B,P,L),Set),
   Set = [_|_], % fail if empty
   minimal(Set,[Camino,Tiempo]).

%minimal es la regla auxiliar que calcula el conjunto con los minutos mas cortos.
minimal([F|R],M) :- min(R,F,M).
min([],M,M).
min([[P,L]|R],[_,M],Min) :- L < M, !, min(R,[P,L],Min).
min([_|R],M,Min) :- min(R,M,Min).

%obten_transbordos(Ruta,Transbordos)
obten_transbordos([Cabeza|Cola],Aux,Transbordos):-
    (es_transbordo(Cabeza) -> obten_transbordos(Cola,[Cabeza|Aux],Transbordos);
    (obten_transbordos(Cola,Aux,Transbordos))).
obten_transbordos([],Aux,Transbordos):-
    !,
    Transbordos = Aux.

%Ejecuta todo el algoritmo con modelo.
main_modelo(Inicio,Fin,Res):-
    min_ruta(Inicio,Fin,Ruta,Tiempo),
    cuenta_estaciones(Ruta,0,NE),
    obten_transbordos(Ruta,[],Transbordos),
    cuenta_estaciones(Transbordos,0,NT),
    Res = [Inicio,Fin,Tiempo,Ruta,NE,Transbordos,NT].

%Caso(Id,Inicio, Fin, Tiempo, lista con la ruta, num estaciones, 
%lista con los transbordos, num transbordos).

%total casos(R). >>> R = número total de casos en la base de onocimientos.
total_casos(R):-
    id_contador(R).

% --ALMACENA UN CASO EN LA BASE DE CONOCIMIENTOS--

%pertenece(a,[a,b,c]). >>> true. Verifica que un elemento forme parte de una lista.
pertenece(X,[X|_]):-!. 
pertenece(X,[_|Z]) :- 
     pertenece(X,Z). 

%coincide_con_caso(tacubaya,sevilla,[tacubaya,juanacatlan,chapultepec,sevilla],R) >>> R=1 
%Verifica que tanto la estación de inicio, como la estación de fin pertenezca a una ruta.
coincide_con_caso(Inicio,Fin,Ruta,R):-
    pertenece(Inicio,Ruta),
    pertenece(Fin,Ruta),
   	R is 1.
coincide_con_caso(_,_,_,R):-
    R is 0.

%rutas_casos(Rutas) >>> Rutas = lista de todas las rutas que hay en los casos.
rutas_casos(Rutas):-
	findall(Ruta, (caso(_,_,_,_,Ruta,_,_,_) , Ruta \== ya), Rutas).

%coincide_con_algun_caso(Inicio,Fin,ListaRutas,R) >>> R = 1 ó 0
%Verifica que tanto la estación de inicio, como la estación de fin pertenezca a alguna ruta de los casos.
coincide_con_algun_caso(Inicio,Fin,[Cabeza|Cola],R):-
    coincide_con_caso(Inicio,Fin,Cabeza,Z),
    (Z =:= 0 -> coincide_con_algun_caso(Inicio,Fin,Cola,R);
    	( R is 1)).
coincide_con_algun_caso(_,_,[],R):-
    R is 0.

%Dado que ingresas toda la información necesaria par un caso, solo lo almacena si no hay ningún caso
%que tenga tanto la estación de inicio, como la estación de fin en su ruta.
almacena_caso(Inicio, Fin, Tiempo, Ruta, NEstaciones, Transbordos, Ntrans):-
    rutas_casos(Rutas),
    coincide_con_algun_caso(Inicio,Fin,Rutas,R),
    (R =:= 0 -> writeln("se almacena el caso a la bases de casos"), 
    ingresa_caso(Inicio, Fin, Tiempo, Ruta, NEstaciones, Transbordos, Ntrans) ;
    	(writeln("no se almacena el caso"))).

%Regla auxiliar en almacena_caso que ingresa un caso a la base de conocimientos.
ingresa_caso(Inicio, Fin, Tiempo, Ruta, NEstaciones, Transbordos, Ntrans):-
    id_contador(X),
    asserta(caso(X,Inicio, Fin, Tiempo, Ruta, NEstaciones, Transbordos, Ntrans)),
    retractall(id_contador),
    Y is X+1,
    asserta(id_contador(Y)).

% --RECUPERA CASO--

%agrega([], Casos) >>> Casos = Lista que contiene a todos los casos de la base de conocimientos
agrega(Lista, Casos):-
    caso(A,B,C,D,E,F,G,H),
    not(member([A,B,C,D,E,F,G,H], Lista)),
    agrega([[A,B,C,D,E,F,G,H]|Lista], Casos),!.
agrega(Lista, Casos):-
    Casos = Lista,!.
obten_casos(Casos):-
    agrega([], Casos).

%ruta(0,Caso,Ruta) >>> Ruta = La ruta en forma de lista de un caso dado.
ruta(5,[Cabeza|_],R):-
	R = Cabeza, !.
ruta(C,[_|Cola],R):-
    A is C+1,
    ruta(A,Cola,R).

%caso_ruta(Ruta,Casos,Caso) >>> Caso = El caso que tiene la ruta dada.
caso_ruta(Ruta,[Cabeza|Cola],Caso):-
    ruta(1,Cabeza,R),
    (Ruta == R ->  append([],Cabeza,Caso);
    (caso_ruta(Ruta,Cola,Caso))).   

%coincide_con_algun_caso_recupera(Inicio,Fin,Rutas,Casos,Ruta) >>> 
%Ruta = La ruta de la base de casos que satisface la necesidad.
coincide_con_algun_caso_recupera(Inicio,Fin,[Cabeza|Cola],Casos,R,B):-
    coincide_con_caso(Inicio,Fin,Cabeza,Z),
    (Z =:= 0 -> coincide_con_algun_caso_recupera(Inicio,Fin,Cola,Casos,R,B);
    	(caso_ruta(Cabeza,Casos,Caso),R = Caso, B = true,!)). 
coincide_con_algun_caso_recupera(_,_,[],_,_,B):-
    B = false,
    write("No hay casos").

%recupera_caso(Inicio,Fin,Ruta) >>> Ruta = Ruta base para la solución al nuvo problema.
recupera_caso(Inicio,Fin,R,B):-
    rutas_casos(Rutas),
    obten_casos(Casos),
    coincide_con_algun_caso_recupera(Inicio,Fin,Rutas,Casos,R,B).

% --ADAPTA CASO--

%corta_ruta_izquierda(Inicio,Fin,RutaInicial,RutaFinal) >>> RutaFinal = Ruta que ya no tiene las estaciones 
%que no sirven para la nueva solución del lado izquierdo.
corta_ruta_izquierda(Inicio,Fin,[Cabeza|Cola],RutaFinal):-
    Cabeza \== Inicio,
    Cabeza \== Fin,
    corta_ruta_izquierda(Inicio,Fin,Cola,RutaFinal).
corta_ruta_izquierda(_,_,Cola,RutaFinal):-
    RutaFinal = Cola,!.

%invierte(Ruta,RutaInvertida,[]) >>> RutaInvertida = Tal cual lo dice su nombre invierte la ruta.
%Esto es muy útil pues las estaciones son bidireccionales.
invierte([X|Y],Z,W):- 
    invierte(Y,Z,[X|W]).
invierte([],Z,Z).

%corta_ruta(Inicio,Fin,RutaInicial,RutaFinal) >>> RutaFinal = Es la ruta que ya no tiene por ningún 
% lado estaiones que no son útiles para la solución.
corta_ruta(Inicio,Fin,RutaInicial,RutaFinal):-
    corta_ruta_izquierda(Inicio,Fin,RutaInicial,R),
    invierte(R,Invertida,[]),
    corta_ruta_izquierda(Inicio,Fin,Invertida,RutaFinal).

%verifica_ruta(Inicio,Ruta,Ruta,RutaFinal) >>> RutaFinal = Ruta que respeta el inicio y el fin que
%quiere el usuario.
verifica_ruta(Inicio,Ruta,[Cabeza|_],RutaFinal):-
    Inicio == Cabeza,
    RutaFinal = Ruta.
verifica_ruta(_,_,Ruta,RutaFinal):-
    invierte(Ruta,RutaFinal,[]).

%tiempo_estacion(Estacion1,Estacion2,Tiempo) >>> Tiempo = El tiempo entre dos estaciones vecinas.
tiempo_estacion(Estacion1,Estacion2,T):-
	estacion(Estacion1,Estacion2,T).
tiempo_estacion(Estacion1,Estacion2,T):-
	estacion(Estacion2,Estacion1,T).

%calcula_tiempo(Ruta,Auxiliar,Tiempo) >>> Tiempo = Calcula el tiempo total de una ruta dada.
calcula_tiempo([],_,Tiempo,R):-!,
    R is Tiempo.
calcula_tiempo([Cabeza|Cola],Auxiliar,Tiempo,R):-
    (Auxiliar == [vacio] ->  Z = Cabeza, calcula_tiempo(Cola,Z,Tiempo,R);
    	tiempo_estacion(Auxiliar,Cabeza,T), C is Tiempo+T,Z = Cabeza, calcula_tiempo(Cola,Z,C,R)).
    

%cuenta_estaciones(Ruta,Contador,NEstaciones) >>> NEstaciones = número de estaciones de una ruta dada.
cuenta_estaciones([],N,R):-
    !,
    R is N.
cuenta_estaciones([_|Cola], N,R) :-
    A is N+1,
    cuenta_estaciones(Cola, A,R). 

%ruta(1,Caso,Transbordos) >>> Transbordos = lista de las estaciones que son conexiones de una caso dado.
transbordos(7,[Cabeza|_],T):-
	T = Cabeza, !.
transbordos(C,[_|Cola],T):-
    A is C+1,
    transbordos(A,Cola,T).

%transborda(RutaF,RutaTrans,Transbordos) >>> Transbordos = lista de las estaciones que son conexiones.
transborda([], _, []).
transborda([Cabeza|Cola], Ruta, [Cabeza|Transbordos]) :-
    member(Cabeza, Ruta),
    transborda(Cola, Ruta, Transbordos).
transborda([_|Cola], Ruta, Transbordos) :-
    transborda(Cola, Ruta, Transbordos).

%adapta_caso(Inicio,Fin,Caso,Res) >>> Res = La solución final, la ruta adpatada con toda la información,
%importante al respecto.
adapta_caso(Inicio,Fin,Caso,Res):-
    ruta(1,Caso,Ruta),
    transbordos(1,Caso,RutaTrans),
    corta_ruta(Inicio,Fin,Ruta,RutaC),
    verifica_ruta(Inicio,RutaC,RutaC,RutaF),
    calcula_tiempo(RutaF,[vacio],0,Tiempo),
    cuenta_estaciones(RutaF,0,NE),
    transborda(RutaF,RutaTrans,Transbordos),
    cuenta_estaciones(Transbordos,0,NT),
    Res = [Inicio,Fin,Tiempo,RutaF,NE,Transbordos,NT].

%Ejecuta todo el algoritmo de casos.
main_casos(Inicio,Fin,Resultado):-
    recupera_caso(Inicio,Fin,CasoInicial,B),
    B == true,
    adapta_caso(Inicio,Fin,CasoInicial,Resultado).
main_casos.


%-- ALGORITMO DE DIJKSTRA --


% insert(Lista, Elemento, Lista_final) >>> Lista_final = lista ordenada el nuevo elemento dentro
% El primer elemento de la lista es más pequeño que V
% se mantienen los elementos de la lista
insert([H | T], V, [H|V1]) :-
    [_,_,Distancia_H] = H,
    [_,_,Distancia_V] = V,
    Distancia_H < Distancia_V,
    insert(T, V, V1).

% El primer elemento de la lista es igual a V
insert([V | T] , V, [V|T]).

% El primer elemento de la lista es mayor que V, se coloca V al inicio de la lista
insert([H | T] , V, [V,H|T]):-
    [_,_,Distancia_H] = H,
    [_,_,Distancia_V] = V,
    Distancia_H >= Distancia_V.

% Se inserta V en una lista vacía, por bacuidad, V es menor que todos los elementos de la lista
insert([], V, [V]).

%juntar_listas(Lista1,Lista2,Lista_final) >>> Lista_final = lista ordenada que combina los elementos de Lista1 y Lista2
juntar_listas([],L,L).
juntar_listas(L,[],L).
juntar_listas([Head1|Tail1], [Head2|Tail2], L) :- 
    [_,_,Distancia_H1] = Head1,
    [_,_,Distancia_H2] = Head2,
    (   Distancia_H1 < Distancia_H2 -> L = [Head1|R], juntar_listas(Tail1,[Head2|Tail2],R) ;
    Distancia_H1 > Distancia_H2 -> L = [Head2|R], juntar_listas([Head1|Tail1],Tail2,R) ;
    L = [Head1,Head2|R], juntar_listas(Tail1,Tail2,R)).

% ordena_lista(Lista, Lista_ordenada) >>> Lista_ordenada = Lista de listas de la forma 
% [Nodo, Nodo, Distancia] ordenada de menor a mayor Distancia
ordena_lista(Lista, Lista_ordenada):-
    ordena_lista(Lista, [], Lista_ordenada).

ordena_lista([],Aux,Aux):-!.
ordena_lista([H | T], Aux, Lista_ordenada):-
    insert(Aux, H, Lista_aux),
    ordena_lista(T, Lista_aux, Lista_ordenada).

% depura_lista(Lista, Lista_depurada) >>> Lista_depurada = Lista sin elementos repetidos
depura_lista([],[]).
depura_lista([H | T], List) :-    
     member(H, T),
     depura_lista( T, List).

depura_lista([H | T], [H|T1]) :- 
      \+member(H, T),
      depura_lista( T, T1).

% crea_cola_p(Estacion, Estacion_Ant, Cola_p) >>> Cola_p = Cola que prioriza las estaciones adyacentes a Estacion por distancia
% Crea la cola de prioridades que guarda las conexiones entre nodos de la forma: [Nodo_hijo, Nodo_padre, Distancia]
crea_cola_p(Estacion, Estacion_Ant, Cola_p):-
    findall([Sig_Estacion, Estacion, Distancia], (estacion(Estacion, Sig_Estacion, Distancia), Sig_Estacion \== Estacion_Ant), Cola_desorden1),
    findall([Sig_Estacion, Estacion, Distancia], (estacion(Sig_Estacion, Estacion, Distancia), Sig_Estacion \== Estacion_Ant), Cola_desorden2),
    append(Cola_desorden1, Cola_desorden2, Cola_desorden),
    ordena_lista(Cola_desorden,Cola_p).

% suma_distancia(Lista, Distancia, Lista_suma) >>> Lista_suma = Lista con la suma de una distancia x 
% a la distancia de la conexion entre nodos de la forma [_,_,Distancia + x]
suma_distancia(Lista, Distancia, Lista_suma):-
	suma_distancia(Lista, Distancia, [], Lista_suma).
	
suma_distancia([],_,Lista,Lista):-!.
suma_distancia([H|T],Distancia,Lista_aux, Lista):-
	[Sig_Estacion, Estacion, Distancia_H] = H,
	Suma is Distancia_H + Distancia,
	insert(Lista_aux, [Sig_Estacion, Estacion, Suma], Lista_aux1),
	suma_distancia(T,Distancia,Lista_aux1,Lista).

% dijkstra(Inicio, Fin, Solucion) >>> Solucion = Ruta más corta que conecta Inicio con Fin
dijkstra(Inicio, Fin, Solucion):-
	Inicio \== Fin,
	crea_cola_p(Inicio,_,Cola_p),
	dijkstra(Cola_p, Fin, [], Ruta),
    depura_lista(Ruta, Solucion),
    !.

% Se buscan los nodos cercanos con la menor distancia disponible.
dijkstra([H|T], Fin, Ruta_acum, Solucion):-
	[Nodo,Nodo_anterior,Distancia_H] = H,
	Nodo \== Fin,
	crea_cola_p(Nodo,Nodo_anterior,Cola_aux),
	suma_distancia(Cola_aux, Distancia_H, Cola_suma),
	juntar_listas(T, Cola_suma, Cola_resto),
	dijkstra(Cola_resto, Fin, Ruta_acum, [Nodo_actual|Nodos_anteriores]),
    ( Nodo == Nodo_actual ->
    	append([Nodo_anterior],[Nodo_actual|Nodos_anteriores],Solucion);
      Nodo \== Nodo_actual ->  
    	Solucion = [Nodo_actual|Nodos_anteriores]
    ).
	
% dijkstra([],_,_,-1) >>> -1 = Bandera que lanza cuando no quedan elementos por revisar, significa que 
% no pudo encontrar el final
dijkstra([],_,_,-1):-!.
dijkstra([H|_], Fin, Ruta_acum, Solucion):-
	[Nodo,Nodo_anterior,_] = H,
	Nodo == Fin,
    append([Nodo_anterior,Nodo],Ruta_acum,Solucion).

%Ejecuta todo el algoritmo con dijkstra.
main_dijkstra(Inicio,Fin,Res):-
    dijkstra(Inicio,Fin,Ruta),
    cuenta_estaciones(Ruta,0,NE),
    obten_transbordos(Ruta,[],Transbordos),
    cuenta_estaciones(Transbordos,0,NT),
    calcula_tiempo(Ruta,[vacio],0,Tiempo),
    Res = [Inicio,Fin,Tiempo,Ruta,NE,Transbordos,NT].

%Ejecuta todo el algoritmo con casos y modelo.
main(Inicio,Fin,Res):-
    recupera_caso(Inicio,Fin,CasoInicial,B),
    B == true,
    adapta_caso(Inicio,Fin,CasoInicial,Res).
main(Inicio,Fin,Res):-
    main_modelo(Inicio,Fin,Res).

%Ejecuta todo el algoritmo con casos y dijkstra.
main2(Inicio,Fin,Res):-
    recupera_caso(Inicio,Fin,CasoInicial,B),
    B == true,
    adapta_caso(Inicio,Fin,CasoInicial,Res).
main2(Inicio,Fin,Res):-
    main_dijkstra(Inicio,Fin,Res).

